#! /usr/bin/env bash

usage="
$0: Prune obsolete evidence from the evidence locker

Usage:
    $0 -h
    $0 -c PRUNE_CONFIG -l LOCKER_URL [-b LOCKER_BRANCH] [-e EMAIL_ADDRESS] [-d]

Options:
-h: show help and exit
-c: prune config. ex: '{\"path/to/filename.json\":\"Reason it is being pruned\"}'
-l: https version of locker repository
-b: main branch used in locker repository. Default: 'main'
-e: your email address. Defaults to '$GIT_EMAIL'
-d: Dry run mode
"

echo "Calling prune-helper script"

set -e

mode="push-remote"
branch="main"
config=""
email="$GIT_EMAIL"
locker=""

while getopts "hc:e:l:b:d" opt; do
    case "$opt" in
        c)
            config=${OPTARG}
            ;;
        e)
            email=${OPTARG}
            ;;
        l)
            locker=${OPTARG}
            ;;
        b)
            branch=${OPTARG}
            ;;
        d)
            mode="dry-run"
            ;;
        h)
            echo "$usage"
            exit 0
            ;;
    esac
done

if [ "$config" = "" ] || [ "$locker" = "" ] || [ "$email" = "" ]; then
    echo "$usage"
    exit 1
fi

prune "$mode" --config "$config" --git-config "{\"user\":{\"email\":\"$email\"}}" --branch "$branch" "$locker"
